{% extends "base.html" %}
{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="fas fa-wallet me-2"></i>Smart Expense Tracker</a>
        <div class="navbar-nav ms-auto">
            <span class="badge bg-light text-dark me-3 px-3 py-2 rounded-pill">Welcome, {{ username }}!</span>
            <a class="btn btn-light btn-sm rounded-pill px-3" href="/logout"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
        </div>
    </div>
</nav>

<div class="container">
    <!-- Statistics Row -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card shadow-sm text-center p-3 border-0">
                <div class="card-body">
                    <h6 class="text-muted">This Month</h6>
                    <h2 class="fw-bold text-primary" id="monthlyTotal">₹0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm text-center p-3 border-0">
                <div class="card-body">
                    <h6 class="text-muted">Total Expenses</h6>
                    <h2 class="fw-bold text-success" id="totalExpenses">₹0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm text-center p-3 border-0">
                <div class="card-body">
                    <h6 class="text-muted">Top Category</h6>
                    <h5 class="fw-bold text-danger" id="topCategory">--</h5>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 p-3">
                <h6 class="text-muted mb-2">Monthly Trend</h6>
                <canvas id="trendChart" height="150"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm border-0 p-3">
                <h6 class="text-muted mb-2">Category Breakdown</h6>
                <canvas id="categoryChart" height="150"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Add Expense -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm border-0 p-4">
                <h5 class="fw-bold mb-3"><i class="fas fa-plus-circle me-2 text-primary"></i>Add New Expense</h5>
                <form id="expenseForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <select class="form-select" id="categorySelect" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="number" class="form-control" id="amountInput" placeholder="Amount (₹)" step="0.01" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="date" class="form-control" id="dateInput" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id="descriptionInput" placeholder="Description (optional)">
                        </div>
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-gradient w-100">Add Expense</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Expenses List -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0 p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold"><i class="fas fa-list me-2 text-primary"></i>Recent Expenses</h5>
                    <div class="d-flex gap-2">
                        <input type="date" class="form-control form-control-sm" id="startDateFilter">
                        <input type="date" class="form-control form-control-sm" id="endDateFilter">
                        <button class="btn btn-sm btn-gradient" onclick="filterExpenses()">Filter</button>
                    </div>
                </div>
                
                <div id="expensesList" class="row g-3">
                    <!-- Expenses will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal fade" id="editExpenseModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Edit Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editExpenseForm">
                <div class="modal-body">
                    <input type="hidden" id="editExpenseId">
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="editCategorySelect" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" class="form-control" id="editAmountInput" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="editDescriptionInput">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="editDateInput" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-gradient rounded-pill">Update Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let categories = [];
let trendChart, categoryChart;

// Init
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('dateInput').valueAsDate = new Date();
    loadCategories();
    loadStatistics();
    loadExpenses();
});

// Categories
async function loadCategories() {
    const res = await fetch('/api/categories');
    categories = await res.json();
    const selects = [document.getElementById('categorySelect'), document.getElementById('editCategorySelect')];
    selects.forEach(select => {
        select.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`;
        });
    });
}

// Statistics
async function loadStatistics() {
    const res = await fetch('/api/statistics');
    const stats = await res.json();
    document.getElementById('monthlyTotal').textContent = `₹${stats.monthly_total.toLocaleString()}`;
    const total = stats.monthly_trend.reduce((s, m) => s + m.amount, 0);
    document.getElementById('totalExpenses').textContent = `₹${total.toLocaleString()}`;
    if (stats.category_breakdown.length > 0) {
        const top = stats.category_breakdown.reduce((a, b) => a.amount > b.amount ? a : b);
        document.getElementById('topCategory').textContent = `${top.icon} ${top.category} (₹${top.amount})`;
    }
    updateTrendChart(stats.monthly_trend);
    updateCategoryChart(stats.category_breakdown);
}

// Expenses
async function loadExpenses(startDate = '', endDate = '') {
    let url = '/api/expenses';
    const params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (params.toString()) url += '?' + params.toString();
    const res = await fetch(url);
    const expenses = await res.json();
    const list = document.getElementById('expensesList');
    if (!expenses.length) {
        list.innerHTML = '<div class="col-12 text-center text-muted"><p>No expenses found</p></div>';
        return;
    }
    list.innerHTML = expenses.map(exp => `
        <div class="col-md-6 col-lg-4">
            <div class="card expense-item shadow-sm h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge px-3 py-2 text-white" style="background:${exp.category.color}">
                            ${exp.category.icon} ${exp.category.name}
                        </span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="editExpense(${exp.id})">Edit</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteExpense(${exp.id})">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <h5 class="fw-bold">₹${exp.amount.toLocaleString()}</h5>
                    <p class="small mb-1">${exp.description || 'No description'}</p>
                    <small class="text-muted">${new Date(exp.date).toLocaleDateString()}</small>
                </div>
            </div>
        </div>
    `).join('');
}

// Add Expense
document.getElementById('expenseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const data = {
        category_id: document.getElementById('categorySelect').value,
        amount: parseFloat(document.getElementById('amountInput').value),
        description: document.getElementById('descriptionInput').value,
        date: document.getElementById('dateInput').value
    };
    const res = await fetch('/api/expenses', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const result = await res.json();
    if (result.success) {
        e.target.reset();
        document.getElementById('dateInput').valueAsDate = new Date();
        loadExpenses(); loadStatistics();
    }
});

// Edit Expense
document.getElementById('editExpenseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('editExpenseId').value;
    const data = {
        category_id: document.getElementById('editCategorySelect').value,
        amount: parseFloat(document.getElementById('editAmountInput').value),
        description: document.getElementById('editDescriptionInput').value,
        date: document.getElementById('editDateInput').value
    };
    const res = await fetch(`/api/expenses/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const result = await res.json();
    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('editExpenseModal')).hide();
        loadExpenses(); loadStatistics();
    }
});
async function editExpense(id) {
    const res = await fetch('/api/expenses');
    const expenses = await res.json();
    const exp = expenses.find(e => e.id === id);
    if (exp) {
        document.getElementById('editExpenseId').value = exp.id;
        document.getElementById('editCategorySelect').value = exp.category.id;
        document.getElementById('editAmountInput').value = exp.amount;
        document.getElementById('editDescriptionInput').value = exp.description || '';
        document.getElementById('editDateInput').value = exp.date;
        new bootstrap.Modal(document.getElementById('editExpenseModal')).show();
    }
}
async function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    const res = await fetch(`/api/expenses/${id}`, {method:'DELETE'});
    const result = await res.json();
    if (result.success) { loadExpenses(); loadStatistics(); }
}
function filterExpenses() {
    loadExpenses(document.getElementById('startDateFilter').value, document.getElementById('endDateFilter').value);
}

// Trend Chart
function updateTrendChart(data) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    if (trendChart) trendChart.destroy();
    const gradient = ctx.createLinearGradient(0,0,0,200);
    gradient.addColorStop(0,"rgba(102,126,234,0.4)");
    gradient.addColorStop(1,"rgba(118,75,162,0)");
    trendChart = new Chart(ctx,{type:'line',data:{
        labels:data.map(d=>d.month),
        datasets:[{label:'Monthly Expenses',data:data.map(d=>d.amount),borderColor:'#667eea',backgroundColor:gradient,pointBackgroundColor:'#fff',pointBorderColor:'#667eea',tension:0.4,fill:true,borderWidth:3}]
    },options:{responsive:true,plugins:{legend:{display:false},tooltip:{backgroundColor:'#333',titleColor:'#fff',bodyColor:'#fff',callbacks:{label:(c)=>`₹${c.formattedValue}`}}},scales:{x:{ticks:{color:'#555'},grid:{color:'rgba(0,0,0,0.05)'}},y:{ticks:{color:'#555'},grid:{color:'rgba(0,0,0,0.05)'}}}}});
}

// Category Chart
function updateCategoryChart(categoryData) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    if (categoryChart) categoryChart.destroy();

    // ✅ Only categories where spending > 0
    const filteredData = categoryData.filter(d => Number(d.amount) > 0);

    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: filteredData.map(d => `${d.icon} ${d.category}`),
            datasets: [{
                data: filteredData.map(d => Number(d.amount)),
                backgroundColor: filteredData.map(d => d.color),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#555',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: '#333',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: (context) => {
                            let value = Number(context.parsed);
                            let total = context.chart._metasets[0].total;
                            let percentage = ((value / total) * 100).toFixed(1);
                            return `₹${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

</script>
{% endblock %}